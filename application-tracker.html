// ============================================================
// Google Apps Script for Job Application Tracker
// ============================================================
// SETUP:
// 1. Go to https://script.google.com and create a new project
// 2. Paste this entire code
// 3. Create a Google Sheet and copy its ID from the URL
//    (the long string between /d/ and /edit in the sheet URL)
// 4. Replace SHEET_ID below with your Sheet ID
// 5. Deploy: Deploy > New Deployment > Web App
//    - Execute as: Me
//    - Who has access: Anyone
// 6. Copy the deployment URL and paste it in the tracker's Sync Settings
// ============================================================

const SHEET_ID = 'https://script.google.com/macros/s/AKfycbw7YS5aGvm3d4J_30SXki44zcvBoOrLvCOVxrP0xvqVM3U4quDEEKZHsdGRq9q8SJnHwg/exec';

function getSheet() {
  const ss = SpreadsheetApp.openById(SHEET_ID);
  let sheet = ss.getSheetByName('Applications');
  if (!sheet) {
    sheet = ss.insertSheet('Applications');
    sheet.appendRow(['id', 'candidate', 'company', 'jobTitle', 'whoApplied', 'jdLink', 'jobDescription', 'resumeFileName', 'dateApplied', 'status']);
  }
  return sheet;
}

function doGet(e) {
  const action = e.parameter.action;

  if (action === 'getAll') {
    const sheet = getSheet();
    const data = sheet.getDataRange().getValues();
    if (data.length <= 1) {
      return jsonResponse({ applications: [] });
    }
    const headers = data[0];
    const apps = [];
    for (let i = 1; i < data.length; i++) {
      const obj = {};
      for (let j = 0; j < headers.length; j++) {
        obj[headers[j]] = data[i][j] !== undefined ? data[i][j].toString() : '';
      }
      apps.push(obj);
    }
    return jsonResponse({ applications: apps });
  }

  return jsonResponse({ status: 'ok' });
}

function doPost(e) {
  try {
    const payload = JSON.parse(e.postData.contents);
    const action = payload.action;

    if (action === 'save' && payload.data) {
      const d = payload.data;
      const sheet = getSheet();
      sheet.appendRow([
        d.id || '',
        d.candidate || '',
        d.company || '',
        d.jobTitle || '',
        d.whoApplied || '',
        d.jdLink || '',
        d.jobDescription || '',
        d.resumeFileName || '',
        d.dateApplied || '',
        d.status || 'Applied'
      ]);
      return jsonResponse({ status: 'saved' });
    }

    if (action === 'delete' && payload.id) {
      const sheet = getSheet();
      const data = sheet.getDataRange().getValues();
      for (let i = 1; i < data.length; i++) {
        if (data[i][0].toString() === payload.id.toString()) {
          sheet.deleteRow(i + 1);
          break;
        }
      }
      return jsonResponse({ status: 'deleted' });
    }

    if (action === 'updateStatus' && payload.id && payload.status) {
      const sheet = getSheet();
      const data = sheet.getDataRange().getValues();
      const headers = data[0];
      const statusCol = headers.indexOf('status');
      for (let i = 1; i < data.length; i++) {
        if (data[i][0].toString() === payload.id.toString()) {
          sheet.getRange(i + 1, statusCol + 1).setValue(payload.status);
          break;
        }
      }
      return jsonResponse({ status: 'updated' });
    }

    return jsonResponse({ status: 'unknown action' });
  } catch (err) {
    return jsonResponse({ error: err.message });
  }
}

function jsonResponse(obj) {
  return ContentService.createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}
